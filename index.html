<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceChat + Chat synchronis√© üê∫</title>
<style>
body { font-family:sans-serif; background:#36393f; color:#fff; margin:0; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:100vh; padding:16px; }
button,input { padding:8px; margin:4px; font-size:14px; }
#chat,#messages { display:flex; flex-direction:column; gap:4px; margin-top:12px; width:300px; max-height:200px; overflow-y:auto; border:1px solid #555; padding:8px; background:#2f3136; }
audio { display:block; margin-top:4px; width:100%; }
</style>
</head>
<body>

<h2>VoiceChat + Chat synchronis√© üê∫</h2>
<input type="text" id="username" placeholder="Pseudo">
<button id="joinBtn">Rejoindre le vocal</button>
<button id="leaveBtn" disabled>Quitter le vocal</button>

<div id="chat"></div>
<input type="text" id="msgInput" placeholder="Entrer un message..." disabled>
<div id="messages"></div>

<script>
// √âtat local
const state = { username:'', userId:Math.random().toString(36).substr(2,9), stream:null, peers:{} };
const STORAGE_KEY='voicechat_shared_state';
let sharedState = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { users:{}, messages:[] };

// Synchronisation entre onglets
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(sharedState)); }
window.addEventListener('storage', e=>{
    if(e.key===STORAGE_KEY){ sharedState=JSON.parse(e.newValue); renderMessages(); renderChatLog(); }
});

// Vocal
async function initStream(){ state.stream = await navigator.mediaDevices.getUserMedia({ audio:true }); }
async function createPeer(remoteId, initiator){
    const pc = new RTCPeerConnection();
    state.stream.getTracks().forEach(t=>pc.addTrack(t,state.stream));
    pc.ontrack=e=>{
        let audio=document.getElementById('audio-'+remoteId);
        if(!audio){ audio=document.createElement('audio'); audio.id='audio-'+remoteId; audio.autoplay=true; document.body.appendChild(audio); }
        audio.srcObject=e.streams[0];
    };
    pc.onicecandidate=e=>{};
    state.peers[remoteId]=pc;
    return pc;
}

// Rejoindre / quitter vocal
async function joinVoice(){
    state.username=document.getElementById('username').value||'User';
    sharedState.users[state.userId]={username:state.username};
    saveState();
    await initStream();
    for(const uid in sharedState.users){ if(uid!==state.userId) await createPeer(uid,true); }
    document.getElementById('joinBtn').disabled=true;
    document.getElementById('leaveBtn').disabled=false;
    document.getElementById('msgInput').disabled=false;
    log('Rejoint le vocal üê∫');
}
function leaveVoice(){
    for(const pc of Object.values(state.peers)) pc.close();
    state.peers={};
    if(state.stream) state.stream.getTracks().forEach(t=>t.stop());
    state.stream=null;
    delete sharedState.users[state.userId];
    saveState();
    document.getElementById('joinBtn').disabled=false;
    document.getElementById('leaveBtn').disabled=true;
    document.getElementById('msgInput').disabled=true;
    log('Vocal quitt√© üê∫');
}

// Chat
function log(msg){ const div=document.createElement('div'); div.textContent=msg; document.getElementById('chat').appendChild(div); }
function sendMessage(text){
    const msg={id:Math.random().toString(36).substr(2,9), user:state.username, text};
    sharedState.messages.push(msg);
    saveState();
    displayMessage(msg);
}
function displayMessage(msg){ const div=document.createElement('div'); div.textContent=`${msg.user}: ${msg.text}`; document.getElementById('messages').appendChild(div); }
function renderMessages(){ document.getElementById('messages').innerHTML=''; sharedState.messages.forEach(displayMessage); }
function renderChatLog(){ 
    document.getElementById('chat').innerHTML=''; 
    Object.values(sharedState.users).forEach(u=>log(`${u.username} est en ligne`));
}

// √âv√©nements
document.getElementById('joinBtn').onclick=joinVoice;
document.getElementById('leaveBtn').onclick=leaveVoice;
document.getElementById('msgInput').addEventListener('keypress', e=>{
    if(e.key==='Enter' && e.target.value.trim()){ sendMessage(e.target.value.trim()); e.target.value=''; }
});

// Initial render
renderMessages();
renderChatLog();
</script>

</body>
</html>
